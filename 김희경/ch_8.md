# 스택과 런타임 시스템

이 장은 중첩 함수 호출, 매개변수 전달, 재귀, 다양한 메모리 할당 및 해제 등의 복잡한 작업을 스택이란 간단한 자료 구조로 지원하는 배경에 대해 알아본다. 런타임 시스템에 대해 알아본다.

## 고수준의 마법: 함수 호출과 스택

함수는 모듈식 프로그래밍의 가장 기본적이고 독립적인 프로그래밍 단위다. 함수는 서로 호출할 수 있는데, 예를 들어 `sqrt`는 `power`를 호출할 수 있다. 이런 호출 시퀀스는 재귀적이거나 필요한 만큼 깊어질 수 있다.

### 함수 호출 시 처리해야 할 작업

일반적으로 한 함수가 다른 함수를 호출할 때 다음과 같은 추가 작업을 처리해야 한다:

1. **반환 주소 저장**: 피호출자가 실행을 완료한 후에 제어를 반환해야 하는 호출자의 코드 내 주소
2. **호출자의 메모리 자원 저장**: 현재 함수의 상태 보존
3. **피호출자에게 메모리 자원 할당**: 새 함수 실행을 위한 공간 확보
4. **피호출자의 코드에서 호출자의 인수를 사용할 수 있게 만듦**: 매개변수 전달
5. **피호출자의 코드 실행을 시작**: 새 함수 실행 개시

### 함수 복귀 시 처리해야 할 작업

반대로 피호출자가 종료되고 값을 반환할 때 다음과 같은 작업을 처리해야 한다:

1. **피호출자의 반환 값을 호출자 코드에서 사용할 수 있게 만듦**: 결과값 전달
2. **피호출자가 사용한 메모리 자원을 반납**: 할당된 공간 해제
3. **이전에 저장해 둔 호출자의 메모리 자원 복원**: 호출자 상태 복구
4. **이전에 저장한 반환 주소를 되찾음**: 돌아갈 위치 결정
5. **반환 주소부터 호출자의 코드 실행을 재개**: 원래 흐름으로 복귀

이러한 함수 호출과 반환에 대한 런타임 프레임워크는 스택 자료구조를 활용하여 구현된다.

## 프로그램 실행 흐름 제어

### 분기(Branching)

컴퓨터 프로그램의 기본 흐름은 순차적이며, 명령을 하나씩 차례로 실행한다. 분기는 이러한 순차적 흐름을 변경하는 메커니즘이다.

- **무조건 분기**: `goto destination`으로 실행, destination에는 다음 실행될 명령어의 실제 메모리 주소가 들어간다.
- **조건부 분기**: `if-goto symbol`과 같은 형태로, 조건이 참일 때만 분기한다.

분기는 가장 기초적인 형태에서는 메모리 주소를 직접 지정하지만, 더 추상적인 방식으로는 기호 레이블을 사용할 수 있다.

### 스택 프레임의 동작 원리

함수 호출 시 스택에 새로운 프레임(Frame)이 생성된다. 이 프레임은 다음과 같은 요소로 구성된다:

1. **지역 변수(Local Variables)**: 함수 내에서 사용되는 변수들
2. **인자(Arguments)**: 함수에 전달된 매개변수
3. **반환 주소(Return Address)**: 함수 실행 후 돌아갈 위치
4. **이전 프레임 포인터(Previous Frame Pointer)**: 호출자의 스택 프레임 위치

함수가 종료되면 스택 프레임은 해제되고, 제어는 호출자에게 반환된다.

## VM 언어와 스택 기반 연산

VM 언어는 스택 기반 아키텍처를 채택하고 있으며, 다음과 같은 특징을 가진다:

1. **스택 조작 명령어**: push, pop 등으로 스택의 데이터를 관리
2. **산술/논리 연산**: add, sub, and, or 등의 연산은 스택의 최상위 요소들을 대상으로 수행
3. **메모리 접근**: 지역 변수, 인자, 정적 변수 등에 접근하기 위한 명령어
4. **분기 명령어**: goto, if-goto 등으로 프로그램 흐름 제어
5. **함수 관련 명령어**: call, return 등으로 함수 호출과 반환 처리

## 요약

스택은 간단한 자료 구조이지만 함수 호출, 매개변수 전달, 지역 변수 관리, 재귀 등 현대 프로그래밍 언어의 핵심 기능을 지원하는 필수적인 메커니즘이다. VM 수준에서 스택을 이해하면 고수준 언어의 동작 원리와 컴퓨터 시스템의 기본 구조를 더 깊이 이해할 수 있다.

함수 호출과 분기는 모든 고수준 프로그래밍 언어의 기본적인 개념이며, 이는 VM 명세를 통해 하드웨어와 소프트웨어 사이의 중간 추상화 계층으로 구현된다.
